import{NextResponse as e}from"next/server";import{COOKIE_LOCALE_NAME as n,HEADER_LOCALE_NAME as o}from"../shared/constants.js";import{matchesPathname as a}from"../shared/utils.js";import l from"./getAlternateLinksHeaderValue.js";import t from"./resolveLocale.js";import{isLocaleSupportedOnDomain as r,getNormalizedPathname as i,getKnownLocaleFromPathname as s,getInternalTemplate as c,formatTemplatePathname as d,getBasePath as u,getBestMatchingDomain as f,getPathWithSearch as m}from"./utils.js";function h(e){var n,o,a;e=function(e){if(e.routing){const{routing:n}=e;delete(e={...e}).routing,"prefix"===n.type?e.localePrefix=n.prefix:"domain"===n.type&&(e.domains=n.domains.map((e=>({domain:e.domain,defaultLocale:e.locale,locales:[e.locale]})))),console.error("\n\nThe `routing` option is deprecated, please use `localePrefix` and `domains` instead. Here's your updated configuration:\n\n"+JSON.stringify(e,null,2)+"\n\nThank you so much for following along with the Server Components beta and sorry for the inconvenience!\n\n")}if(e.domains){const{domains:n}=e;(e={...e}).domains=n.map((e=>(e.locale&&console.error("\n\nThe `domain.locale` option is deprecated, please use `domain.defaultLocale` instead."),{...e,defaultLocale:e.locale||e.defaultLocale,...e.locale&&{locales:[e.locale]}})))}return e}(e);return{...e,alternateLinks:null===(n=e.alternateLinks)||void 0===n||n,localePrefix:null!==(o=e.localePrefix)&&void 0!==o?o:"as-needed",localeDetection:null===(a=e.localeDetection)||void 0===a||a}}function p(p){const v=h(p),x=p._matcher;return function(h){var p,L;if(!(!x||x.some((e=>h.nextUrl.pathname.match(e)))))return e.next();const{domain:g,locale:P}=t(v,h.headers,h.cookies,h.nextUrl.pathname),k=(null===(p=h.cookies.get(n))||void 0===p?void 0:p.value)!==P,U=g?g.defaultLocale===P:P===v.defaultLocale,y=(null===(L=v.domains)||void 0===L?void 0:L.filter((e=>r(P,e))))||[],w=null!=v.domains&&!g;function j(n){return e.rewrite(new URL(n,h.url),function(){const e={request:{headers:h.headers}};return k&&(e.request.headers=new Headers(e.request.headers),e.request.headers.set(o,P)),e}())}function q(n,o){const a=new URL(n,h.url);if(y.length>0&&!o){const e=f(g,P,y);e&&(o=e.domain,e.defaultLocale===P&&"as-needed"===v.localePrefix&&(a.pathname=a.pathname.replace("/".concat(P),"")))}return o&&(a.host=o),e.redirect(a.toString())}const S=i(h.nextUrl.pathname,v.locales),H=s(h.nextUrl.pathname,v.locales),T=null!=H;let A,D,R=h.nextUrl.pathname;if(v.pathnames){let e;if([e=P,D]=c(v.pathnames,S),D){const n=v.pathnames[D],o="string"==typeof n?n:n[P];if(a(o,S))R=d(S,o,D,H);else{const a=v.defaultLocale===P||(null==g?void 0:g.defaultLocale)===P;A=q(d(S,"string"==typeof n?n:n[e],o,H||!a?P:void 0))}}}if(!A)if("/"===R){const e=m("/".concat(P),h.nextUrl.search);A="never"===v.localePrefix||U&&"as-needed"===v.localePrefix?j(e):q(e)}else{const e=m(R,h.nextUrl.search);if(T){const n=u(e,H);if("never"===v.localePrefix)A=q(n);else if(H===P)if(U&&"as-needed"===v.localePrefix)A=q(n);else if(v.domains){const o=f(g,H,y);A=(null==g?void 0:g.domain)===(null==o?void 0:o.domain)||w?j(e):q(n,null==o?void 0:o.domain)}else A=j(e);else A=q("/".concat(P).concat(n))}else A="never"===v.localePrefix||U&&("as-needed"===v.localePrefix||v.domains)?j("/".concat(P).concat(e)):q("/".concat(P).concat(e))}var b;(k&&A.cookies.set(n,P,{sameSite:"strict",maxAge:31536e3}),"never"!==v.localePrefix&&v.alternateLinks&&v.locales.length>1)&&A.headers.set("Link",l({config:v,localizedPathnames:null!=D?null===(b=v.pathnames)||void 0===b?void 0:b[D]:void 0,request:h,resolvedLocale:P}));return A}}export{p as default};
