"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("next/server"),a=require("../shared/constants.js"),t=require("../shared/utils.js"),n=require("./getAlternateLinksHeaderValue.js"),l=require("./resolveLocale.js"),o=require("./utils.js");exports.default=function(r){const i=function(e){var a,t,n;return e=function(e){if(e.routing){const{routing:a}=e;delete(e={...e}).routing,"prefix"===a.type?e.localePrefix=a.prefix:"domain"===a.type&&(e.domains=a.domains.map((e=>({domain:e.domain,defaultLocale:e.locale,locales:[e.locale]}))))}if(e.domains){const{domains:a}=e;(e={...e}).domains=a.map((e=>({...e,defaultLocale:e.locale||e.defaultLocale,...e.locale&&{locales:[e.locale]}})))}return e}(e),{...e,alternateLinks:null===(a=e.alternateLinks)||void 0===a||a,localePrefix:null!==(t=e.localePrefix)&&void 0!==t?t:"as-needed",localeDetection:null===(n=e.localeDetection)||void 0===n||n}}(r),s=r._matcher;return function(r){var c,d;if(!(!s||s.some((e=>r.nextUrl.pathname.match(e)))))return e.NextResponse.next();const{domain:u,locale:f}=l.default(i,r.headers,r.cookies,r.nextUrl.pathname),m=(null===(c=r.cookies.get(a.COOKIE_LOCALE_NAME))||void 0===c?void 0:c.value)!==f,h=u?u.defaultLocale===f:f===i.defaultLocale,p=(null===(d=i.domains)||void 0===d?void 0:d.filter((e=>o.isLocaleSupportedOnDomain(f,e))))||[],v=null!=i.domains&&!u;function x(t){return e.NextResponse.rewrite(new URL(t,r.url),function(){const e={request:{headers:r.headers}};return m&&(e.request.headers=new Headers(e.request.headers),e.request.headers.set(a.HEADER_LOCALE_NAME,f)),e}())}function L(a,t){const n=new URL(a,r.url);if(p.length>0&&!t){const e=o.getBestMatchingDomain(u,f,p);e&&(t=e.domain,e.defaultLocale===f&&"as-needed"===i.localePrefix&&(n.pathname=n.pathname.replace("/".concat(f),"")))}return t&&(n.host=t),e.NextResponse.redirect(n.toString())}const g=o.getNormalizedPathname(r.nextUrl.pathname,i.locales),P=o.getKnownLocaleFromPathname(r.nextUrl.pathname,i.locales),q=null!=P;let E,A,O=r.nextUrl.pathname;if(i.pathnames){let e;if([e=f,A]=o.getInternalTemplate(i.pathnames,g),A){const a=i.pathnames[A],n="string"==typeof a?a:a[f];if(t.matchesPathname(n,g))O=o.formatTemplatePathname(g,n,A,P);else{const t=i.defaultLocale===f||(null==u?void 0:u.defaultLocale)===f;E=L(o.formatTemplatePathname(g,"string"==typeof a?a:a[e],n,P||!t?f:void 0))}}}if(!E)if("/"===O){const e=o.getPathWithSearch("/".concat(f),r.nextUrl.search);E="never"===i.localePrefix||h&&"as-needed"===i.localePrefix?x(e):L(e)}else{const e=o.getPathWithSearch(O,r.nextUrl.search);if(q){const a=o.getBasePath(e,P);if("never"===i.localePrefix)E=L(a);else if(P===f)if(h&&"as-needed"===i.localePrefix)E=L(a);else if(i.domains){const t=o.getBestMatchingDomain(u,P,p);E=(null==u?void 0:u.domain)===(null==t?void 0:t.domain)||v?x(e):L(a,null==t?void 0:t.domain)}else E=x(e);else E=L("/".concat(f).concat(a))}else E="never"===i.localePrefix||h&&("as-needed"===i.localePrefix||i.domains)?x("/".concat(f).concat(e)):L("/".concat(f).concat(e))}var U;(m&&E.cookies.set(a.COOKIE_LOCALE_NAME,f,{sameSite:"strict",maxAge:31536e3}),"never"!==i.localePrefix&&i.alternateLinks&&i.locales.length>1)&&E.headers.set("Link",n.default({config:i,localizedPathnames:null!=A?null===(U=i.pathnames)||void 0===U?void 0:U[A]:void 0,request:r,resolvedLocale:f}));return E}};
