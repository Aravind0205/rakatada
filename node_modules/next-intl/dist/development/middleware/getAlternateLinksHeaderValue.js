'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var utils = require('./utils.js');

function getAlternateEntry(url, locale) {
  return "<".concat(url, ">; rel=\"alternate\"; hreflang=\"").concat(locale, "\"");
}

/**
 * See https://developers.google.com/search/docs/specialty/international/localized-versions
 */
function getAlternateLinksHeaderValue(_ref) {
  var _getHost, _request$headers$get;
  let {
    config,
    localizedPathnames,
    request,
    resolvedLocale
  } = _ref;
  const normalizedUrl = request.nextUrl.clone();
  normalizedUrl.host = (_getHost = utils.getHost(request.headers)) !== null && _getHost !== void 0 ? _getHost : normalizedUrl.host;
  normalizedUrl.protocol = (_request$headers$get = request.headers.get('x-forwarded-proto')) !== null && _request$headers$get !== void 0 ? _request$headers$get : normalizedUrl.protocol;
  normalizedUrl.pathname = utils.getNormalizedPathname(normalizedUrl.pathname, config.locales);
  function getLocalizedPathname(pathname, locale) {
    if (localizedPathnames && typeof localizedPathnames === 'object') {
      return utils.formatTemplatePathname(pathname, localizedPathnames[resolvedLocale], localizedPathnames[locale]);
    } else {
      return pathname;
    }
  }
  const links = config.locales.flatMap(locale => {
    function prefixPathname(pathname) {
      if (pathname === '/') {
        return "/".concat(locale);
      } else {
        return "/".concat(locale).concat(pathname);
      }
    }
    let url;
    if (config.domains) {
      const domainConfigs = config.domains.filter(cur => utils.isLocaleSupportedOnDomain(locale, cur)) || [];
      return domainConfigs.map(domainConfig => {
        url = new URL(normalizedUrl);
        url.port = '';
        url.host = domainConfig.domain;
        url.pathname = getLocalizedPathname(url.pathname, locale);
        if (locale !== domainConfig.defaultLocale || config.localePrefix === 'always') {
          url.pathname = prefixPathname(url.pathname);
        }
        return getAlternateEntry(url.toString(), locale);
      });
    } else {
      let pathname;
      if (localizedPathnames && typeof localizedPathnames === 'object') {
        pathname = getLocalizedPathname(normalizedUrl.pathname, locale);
      } else {
        pathname = normalizedUrl.pathname;
      }
      if (locale !== config.defaultLocale || config.localePrefix === 'always') {
        pathname = prefixPathname(pathname);
      }
      url = new URL(pathname, normalizedUrl);
    }
    return getAlternateEntry(url.toString(), locale);
  });

  // Add x-default entry
  if (!config.domains) {
    const url = new URL(getLocalizedPathname(normalizedUrl.pathname, config.defaultLocale), normalizedUrl);
    links.push(getAlternateEntry(url.toString(), 'x-default'));
  }
  return links.join(', ');
}

exports.default = getAlternateLinksHeaderValue;
